/*
Copyright Â© 2025 AB TRANSITION IT abtransitionit@hotmail.com
*/
package kbe

import (
	coregocli "github.com/abtransitionit/gocore/gocli"
	core_helm "github.com/abtransitionit/gocore/k8s-helm"
	"github.com/abtransitionit/gocore/logx"
	corephase "github.com/abtransitionit/gocore/phase"
	liuxoservice "github.com/abtransitionit/golinux/oservice"
	linuxkernel "github.com/abtransitionit/golinux/oskernel"
	"github.com/abtransitionit/gotask/dnfapt"
	"github.com/abtransitionit/gotask/gocli"
	taskk8s "github.com/abtransitionit/gotask/k8s"
	task_cilium "github.com/abtransitionit/gotask/k8s-cilium"
	helm "github.com/abtransitionit/gotask/k8s-helm"
	"github.com/abtransitionit/gotask/luc"
	"github.com/abtransitionit/gotask/oservice"
	taskoskernel "github.com/abtransitionit/gotask/oskernel"
	"github.com/abtransitionit/gotask/selinux"
	"github.com/abtransitionit/gotask/util"
	"github.com/abtransitionit/gotask/vm"
	"github.com/spf13/viper"
)

// Package var
var (
	cfg             *Config
	cmdName         = "kbe"
	sDesc           = "Manage Kubernetes clusters."
	k8sShortVersion = "1.32"
	k8sLongVersion  = "1.32.0"
)

// Package variables
var (
	wkf           *corephase.Workflow
	targets       []corephase.Target
	targetsCP     []corephase.Target
	targetsWorker []corephase.Target
	logger        = logx.GetLogger()
)

// Package variables : confifg1s
var (
	K8sVersionLong   = "1.32.0"
	K8sVersionShort  = "1.32"
	customRcFileName = ".profile.luc "  // name of the user's custom rc file
	binFolderPath    = "/usr/local/bin" // location of binaries
)

// Package variables : confifg2
var (
	listRequiredDaPackage = []string{"gnupg"} // gnupg/{gpg}
	listGoCli             = coregocli.SliceGoCli{
		{Name: "helm", Version: "3.17.3"},
		{Name: "cilium", Version: "0.18.7"},
	}

	// sliceDaRepo = linuxdnfapt.SliceDaRepo{
	// 	{Name: "crio", FileName: "kbe-crio", Version: K8sVersionShort},
	// 	{Name: "k8s", FileName: "kbe-k8s", Version: K8sVersionShort},
	// }
	// sliceDaPackNode = linuxdnfapt.SliceDaPack{
	// 	{Name: "crio"},
	// 	{Name: "kubeadm"},
	// 	{Name: "kubelet"},
	// }
	// sliceDaPackCplane = linuxdnfapt.SliceDaPack{
	// 	{Name: "kubectl"},
	// }
	kernelFilename = "99-kbe.conf"
	sliceOsKModule = []string{"overlay", "br_netfilter"}
	sliceOsKParam  = linuxkernel.SliceOsKParam{
		{Kvp: "net.ipv4.ip_forward=1", Description: "Enable IPv4 packet forwarding - core kernel parameter"},
		{Kvp: "net.bridge.bridge-nf-call-iptables=1", Description: "Pass bridged IPv4 traffic to iptables - br_netfilter module parameter"},
		{Kvp: "net.bridge.bridge-nf-call-ip6tables=1", Description: "Pass bridged IPv6 traffic to iptables - br_netfilter module parameter"},
	}
	sliceOsServiceStart = []liuxoservice.OsService{
		{Name: "crio"},
	}
	sliceOsServiceEnable = []liuxoservice.OsService{
		{Name: "crio"},
		{Name: "kubelet"},
	}
	sliceHelmRepo = []core_helm.HelmRepo{
		{Name: "cilium"},
		{Name: "kdabsh"},
	}
	sliceHelmRelease = []core_helm.HelmRelease{
		{
			Name:      "kbe-mxtest",
			Chart:     core_helm.HelmChart{FullName: "~/wkspc/chart/mxtest"},
			Namespace: "default",
		},
	}
	// k8sConf = linuxk8s.K8sConf{
	// 	K8sVersion:     K8sVersionLong,
	// 	K8sPodCidr:     "192.168.0.0/16",
	// 	K8sServiceCidr: "172.16.0.0/16",
	// 	CrSocketName:   "unix:///var/run/crio/crio.sock",
	// }
	// ciliumConf = core_cilium.CiliumConf{
	// 	K8sPodCidr:   cfg.Cluster.PodCidr,
	// 	K8sApiServer: "o1u",
	// }
)

func init() {
	// Load YAML file into struct
	viper.SetConfigFile("/Users/max/wkspc/git/goluc/cmd/workflow/kbe/conf.yaml")
	if err := viper.ReadInConfig(); err != nil {
		return
	}
	if err := viper.Unmarshal(&cfg); err != nil {
		return
	}

	// create the targets slice
	for _, vmName := range cfg.Node.All {
		targets = append(targets, &corephase.Vm{NameStr: vmName})
	}
	for _, vmName := range cfg.Node.ControlPlane {
		targetsCP = append(targetsCP, &corephase.Vm{NameStr: vmName})
	}
	for _, vmName := range cfg.Node.Worker {
		targetsWorker = append(targetsWorker, &corephase.Vm{NameStr: vmName})
	}

	// create the workflow
	var err error
	wkf, err = corephase.NewWorkflowFromPhases(
		corephase.NewPhase("checkVmAccess", "Check if VMs are SSH reachable", vm.CheckVmSshAccess, nil),
		corephase.NewPhase("copyAgent", "copy LUC CLI agent to all VMs", luc.DeployLuc, []string{"checkVmAccess"}),
		corephase.NewPhase("upgradeOs", "provision OS nodes with latest dnfapt packages and repositories.", dnfapt.UpgradeVmOs, []string{"copyAgent"}),
		corephase.NewPhase("updateApp", "provision required/missing standard dnfapt packages.", dnfapt.UpdateVmOsApp(listRequiredDaPackage), []string{"upgradeOs"}),
		corephase.NewPhase("installDaRepository", "provision Dnfapt package repositor(y)(ies).", dnfapt.InstallDaRepository(cfg.Da.Repo.Node), []string{"updateApp"}),
		corephase.NewPhase("installDaPackage", "provision Dnfapt package(s) on all nodes.", dnfapt.InstallDaPackage(cfg.Da.Pkg.Node), []string{"installDaRepository"}),
		corephase.NewPhase("installDaPackageCplane", "provision Dnfapt package(s) on CPlane only.", dnfapt.InstallDaPackage(cfg.Da.Pkg.ControlPlane, targetsCP), []string{"installDaPackage"}),
		corephase.NewPhase("loadOsKernelModule", "load OS kernel module(s).", taskoskernel.LoadOsKModule(sliceOsKModule, kernelFilename), []string{"installDaPackage"}),
		corephase.NewPhase("loadOsKernelParam", "set OS kernel paramleter(s).", taskoskernel.LoadOsKParam(sliceOsKParam, kernelFilename), []string{"loadOsKernelModule"}),
		corephase.NewPhase("confSelinux", "Configure Selinux.", selinux.ConfigureSelinux(), []string{"loadOsKernelParam"}),
		corephase.NewPhase("enableOsService", "enable OS services to start after a reboot", oservice.EnableOsService(sliceOsServiceEnable), []string{"confSelinux"}),
		corephase.NewPhase("startOsService", "start OS services for current session", oservice.StartOsService(sliceOsServiceStart), []string{"confSelinux"}),
		corephase.NewPhase("resetCPlane", "reset the control plane(s).", taskk8s.ResetNode(targetsCP), []string{"startOsService"}),
		corephase.NewPhase("initCPlane", "initialize the control plane(s) (aka. boostrap the cluster).", taskk8s.InitCPlane(targetsCP, cfg.Cluster), []string{"resetCPlane"}),
		corephase.NewPhase("resetWorker", "reset the workers(s).", taskk8s.ResetNode(targetsWorker), []string{"initCPlane"}),
		corephase.NewPhase("addWorker", "Add the K8s worker(s) to the K8s cluster.", taskk8s.AddWorker(targetsCP[0], targetsWorker), []string{"resetWorker"}),
		corephase.NewPhase("confKubectlOnCPlane", "Configure kubectl on the control plane(s).", taskk8s.ConfigureKubectlOnCplane(targetsCP[0]), []string{"resetWorker"}),
		corephase.NewPhase("installGoCliCplane", "provision Go CLI(s).", gocli.InstallGoCliOnVm(listGoCli, targetsCP), []string{"confKubectlOnCPlane"}),
		corephase.NewPhase("createRcFile", "create a custom RC file in user's home.", util.CreateCustomRcFile(customRcFileName), []string{"installGoCliCplane"}),
		corephase.NewPhase("setPathEnvar", "configure PATH envvar into current user's custom RC file.", util.SetPath(binFolderPath, customRcFileName), []string{"createRcFile"}),
		corephase.NewPhase("installHelmRepo", "install Helm chart repositories.", helm.InstallHelmRepo(sliceHelmRepo), []string{"setPathEnvar"}),
		corephase.NewPhase("createCiliumRelease", "install and configure the CNI: Cilium on all nodes.", task_cilium.InstallCniCilium, []string{"installHelmRepo"}),
	)
	// corephase.NewPhase("installHelmRepo2", "install Helm chart repositories.", helm.InstallHelmRepo2(sliceHelmRepo, targetsCP), []string{"setPathEnvar"}),
	if err != nil {
		logger.ErrorWithStack(err, "failed to build workflow: %v")
	}
}

// var KbeGoCliConfigMap = config.CustomCLIConfigMap{
// 	"kubeadm": {
// 		Name:      "kubeadm",
// 		Version:   KbeVersion,
// 		DstFolder: "/usr/local/bin",
// 	},
// 	"kubectl": {
// 		Name:      "kubectl",
// 		Version:   KbeVersion,
// 		DstFolder: "/usr/local/bin",
// 	},
// 	"helm": {
// 		Name:      "helm",
// 		Version:   "3.17.3",
// 		DstFolder: "/usr/local/bin",
// 	},
// }
// corephase.NewPhase("installGoCli", "provision Go CLI(s).", taskgocli.InstallOnVm(listGoCli), []string{"updateApp"}),
