name: kindn
description: create a KIND (Kubernetes in Docker) cluster
phases:
  NodeSsh:
    description: Check if VMs are SSH reachable
    node: all
    fn: vm.CheckVmSshAccess
    Dependency: []

  LucAgent:
    description: Copy LUC CLI agent to all VMs
    node: all
    fn: luc.DeployLuc
    Dependency:
      - NodeSsh

  OsUpgrade:
    description: Provision OS nodes with latest dnfapt packages and repositories
    node: all
    fn: dnfapt.UpgradeVmOs
    Dependency:
      - LucAgent

  AppUpdate:
    description: Provision required/missing standard dnfapt packages
    node: all
    fn: dnfapt.UpdateVmOsApp
    params:
      daPkgKey: da.pkg.required
    Dependency:
      - OsUpgrade

  GoCli:
    description: Provision Go CLI(s)
    node: all
    fn: taskgocli.InstallGoCliOnVm
    params:
      goCliKey: goCli
      targetsKey: node
    Dependency:
      - AppUpdate

  InstallService:
    description: Provision OS service(s)
    node: all
    fn: oservice.InstallOsService
    params:
      serviceKey: service
    Dependency:
      - GoCli
      - EnvarSet

  UserService:
    description: Allows user services to be session-independent
    node: all
    fn: oservice.EnableLinger
    Dependency:
      - GoCli

  RcFile:
    description: Create a custom RC file in user's home
    node: all
    fn: util.CreateCustomRcFile
    params:
      rcFileNameKey: customRcFileName
    Dependency:
      - UserService

  EnvarPath:
    description: Configure PATH envvar into current user's custom RC file
    node: all
    fn: util.SetPath
    params:
      binFolderPathKey: binFolderPath
      rcFileNameKey: customRcFileName
    Dependency:
      - RcFile

  EnvarSet:
    description: Define envvars into current user's custom RC file
    node: all
    fn: util.SetEnvar
    params:
      rcFileNameKey: customRcFileName
      envVarsKey: envar
    Dependency:
      - EnvarPath

  ServiceStart:
    description: Start OS services needed by the app
    node: all
    fn: oservice.StartOsService
    params:
      serviceKey: service
    Dependency:
      - InstallService
      - EnvarSet

  Containerd:
    description: Sets up a rootless containerd env Linux session independent for the current user
    node: all
    fn: ctd.SetContainerd
    Dependency:
      - ServiceStart
