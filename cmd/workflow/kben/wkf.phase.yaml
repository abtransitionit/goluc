name: kben
description: create a KBE (Kubernetes Easy) cluster
phases:
  NodeSsh:
    description: Check node is SSH reachable
    node: all
    fn: vm.CheckVmSshAccess
    dependencies: []

  LucAgent:
    description: Copy LUC CLI agent
    node: all
    fn: luc.DeployLuc
    dependencies:
      - NodeSsh

  OsUpgrade:
    description: Upgrade native OS packages and repositories to version latest
    node: all
    fn: dnfapt.UpgradeVmOs
    dependencies:
      - LucAgent

  AppUpdate:
    description: Provision required/missing native standard OS packages
    node: all
    fn: dnfapt.UpdateVmOsApp
    params:
      daPkgKey: da.pkg.node
    dependencies:
      - OsUpgrade

  DaRepoInstall:
    description: Provision native OS package repository(ies)
    node: all
    fn: dnfapt.InstallDaRepository
    params:
      repoKey: da.repo.node
    dependencies:
      - AppUpdate

  DaPkgInstall:
    description: Provision native OS package(s)
    node: all
    fn: dnfapt.InstallDaPackage
    params:
      pkgKey: da.pkg.node
    dependencies:
      - DaRepoInstall

  DaPkgInstall2:
    description: Provision native OS package(s) for control plane
    node: controlPlane
    fn: dnfapt.InstallDaPackage
    params:
      pkgKey: da.pkg.controlPlane
      targetsKey: controlPlaneNodes
    dependencies:
      - DaPkgInstall

  KernelModuleLoad:
    description: Load OS kernel module(s)
    node: all
    fn: taskoskernel.LoadOsKModule
    params:
      modulesKey: osKernelModules
      kernelFileKey: kernelFilename
    dependencies:
      - DaPkgInstall
      - DaPkgInstall2

  KernelParamSet:
    description: Set OS kernel parameter(s)
    node: all
    fn: taskoskernel.LoadOsKParam
    params:
      paramsKey: osKernelParams
      kernelFileKey: kernelFilename
    dependencies:
      - KernelModuleLoad

  SelinuxConf:
    description: Configure SELinux
    node: all
    fn: selinux.ConfigureSelinux
    dependencies:
      - KernelParamSet

  ServiceEnable:
    description: Enable OS services to start after a reboot
    node: all
    fn: oservice.EnableOsService
    params:
      serviceKey: osServiceEnable
    dependencies:
      - SelinuxConf

  ServiceStart:
    description: Start OS services for current session
    node: all
    fn: oservice.StartOsService
    params:
      serviceKey: osServiceStart
    dependencies:
      - SelinuxConf
      - ServiceEnable

  Reset1:
    description: Reset the control plane node(s)
    node: controlPlane
    fn: taskk8s.ResetNode
    params:
      targetsKey: controlPlaneNodes
    dependencies:
      - ServiceStart

  Init:
    description: Initialize/bootstrap the cluster
    node: controlPlane
    fn: taskk8s.InitCPlane
    params:
      targetsKey: controlPlaneNodes
      clusterKey: clusterConfig
    dependencies:
      - Reset1

  Reset2:
    description: Reset the worker node(s)
    node: worker
    fn: taskk8s.ResetNode
    params:
      targetsKey: workerNodes
    dependencies:
      - Init

  Add:
    description: Add worker node(s) to the cluster
    node: worker
    fn: taskk8s.AddWorker
    params:
      masterNodeKey: controlPlaneNodes[0]
      targetsKey: workerNodes
    dependencies:
      - Reset2

  KubectlConf:
    description: Configure kubectl
    node: controlPlane
    fn: taskk8s.ConfigureKubectlOnCplane
    params:
      masterNodeKey: controlPlaneNodes[0]
    dependencies:
      - Reset2

  GoCli:
    description: Provision Go CLI(s)
    node: controlPlane
    fn: gocli.InstallGoCliOnVm
    params:
      goCliKey: goCli
      targetsKey: controlPlaneNodes
    dependencies:
      - KubectlConf

  RcFile:
    description: Create a custom RC file in user's home
    node: controlPlane
    fn: util.CreateCustomRcFile
    params:
      rcFileNameKey: customRcFileName
    dependencies:
      - GoCli

  EnvarPath:
    description: Configure PATH envvar into current user's custom RC file
    node: controlPlane
    fn: util.SetPath
    params:
      binFolderPathKey: binFolderPath
      rcFileNameKey: customRcFileName
    dependencies:
      - RcFile

  HelmRepo:
    description: Install Helm chart repositories
    node: controlPlane
    fn: helm.InstallHelmRepo
    params:
      helmRepoKey: helmRepo
    dependencies:
      - EnvarPath

  Cilium:
    description: Install and configure the CNI Cilium
    node: controlPlane
    fn: task_cilium.InstallCniCilium
    dependencies:
      - HelmRepo
