name: kind
description: create a KIND (Kubernetes in Docker) cluster
phases:
  CheckSshConf:
    description: check node is SSH configured on the host (aka. ~/.ssh/config.d/)
    node: node.bastion
    fn: CheckSshConf
    param: 
      - node.all

  CheckSshAccess:
    description: Check node is SSH reachable from the host
    node: node.bastion
    fn: CheckSshAccess
    param:
      - node.all
    dependency:
      - CheckSshConf

  DeployAgent:
    description: copy luca agent from the host to the node (only if it is different from the host)
    node: node.bastion
    fn: DeployAgent
    param: 
      - node.all
      - agent
    dependency:
      - CheckSshAccess

  UpgradeOs:
    description: Upgrade node (linux OS) native repositories and packages to the latest version
    node: node.all
    fn: UpgradeOs
    dependency:
      - DeployAgent

  RebootIfNeeded:
    description: Reboot a node if needed
    node: node.all
    fn: RebootIfNeeded
    dependency:
      - UpgradeOs

  WaitIsOnline:
    description: Check a node is ssh reachable from a host (after a possible reboot) within a delay
    node: node.bastion
    fn: WaitIsOnline
    param: 
      - node.all
      - ssh.delay
    dependency:
      - RebootIfNeeded

  UpdateOs:
    description: Provision required/missing native standard OS packages
    node: node.all
    fn: UpdateOs
    dependency:
      - WaitIsOnline

  AddRepoNative:
    description: Provision native OS package repository(ies)
    node: node.all
    fn: AddRepoNative
    param:
      - onpm.repo.node
    dependency:
      - UpdateOs

  AddPkgNative:
    description: Provision native OS package(s)
    node: node.all
    fn: AddPkgNative
    param:
      - onpm.pkg.node.all
    dependency:
      - AddRepoNative

  AddPkgGo:
    description: Provision Go CLI(s)
    node: node.cp
    fn: InstallGoCli
    param:
      - gopm
    dependency:
      - AddPkgNative

  CreateRc:
    description: Create a user's custom RC file
    node: node.cp
    fn: CreateRcFile
    param:
      - file.crc
    dependency:
      - AddPkgGo


  InstallService:
    description: Provision OS service(s)
    node: node.all
    fn: InstallService
    param:
      - service.install
    dependency:
      - AddPkgGo
      - AddEnvar

  ConfigureUserServices:
    description: Allows user services to be session-independent
    node: node.all
    fn: EnableLinger
    dependency:
      - AddPkgGo


  AddPath:
    description: Update and Add the envvar:PATH into the user's custom RC file
    node: node.cp
    fn: UpdateRcFile
    param:
      - file.crc
      - file.binf
    dependency:
      - CreateRc


  AddEnvar:
    description: Add the other envvars into the user's custom RC file
    node: node.all
    fn: UpdateRcFile
    param:
      - file.crc
      - envar
    dependency:
      - AddPath

  ServiceStart:
    description: Start OS services needed by the app
    node: node.all
    fn: StartService
    param:
      - service
    dependency:
      - InstallService
      - AddEnvar

  Containerd:
    description: Sets up a rootless containerd env Linux session independent for the current user
    node: node.all
    fn: SetContainerd
    dependency:
      - ServiceStart
