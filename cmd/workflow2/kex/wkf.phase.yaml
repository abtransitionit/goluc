name: kex
description: extend a Kubernetes cluster with basic EXtensions
phases:
  CheckNodeConf:
    description: check cluster's bastion is SSH configured on the host (aka. ~/.ssh/config.d/)
    node: cluster.bastion
    fn: CheckNodeConf

  CheckNodeSshAccess:
    description: Check cluster's node is SSH reachable from the bastion
    node: cluster.bastion
    fn: CheckNodeSshAccess
    dependency:
      - CheckNodeConf
    param: 
      - cluster.node

  DeployAgent:
    description: copy luca agent from the bastion to the cluster's node (only if it is different from the bastion)
    node: node.bastion
    fn: DeployAgent
    param: 
      - cluster.node
      - agent
    dependency:
      - CheckNodeSshAccess

  DeployCustomLpp:
    description: deploy the customized Rancher local Path Provisionner.
    node: node.helm
    fn: ApplyManifest
    param:
      - manifest.apply
    dependency:
      - DeployAgent

  CreateSecret:
    description: create a login/pwd used for Basic Auth to access the private docker registry.
    node: node.helm
    fn: CreateSecret
    param:
      - secret.cimreg
    dependency:
      - DeployCustomLpp

  # AddNamespace:
  #   description: create a namespace where to deploy the registry.
  #   node: node.helm
  #   fn: AddNs
  #   param:
  #     - app.namespace
  #   dependency:
  #     - DeployLpp

  # AddContainerRegistry:
  #   # A private cluster container registry, with admission control enforcing that only images from it can run.
  #   description: deploy A Deployement with registry:2.
  #   node: node.helm
  #   fn: AddContainerRegistry
  #   param:
  #     - helm.repo
  #   dependency:
  #     - DeployAgent


