name: kex
description: extend a Kubernetes cluster with basic EXtensions
phases:
  CheckNodeConf:
    description: check cluster's bastion is SSH configured on the host (aka. ~/.ssh/config.d/)
    node: cluster.bastion
    fn: CheckNodeConf

  CheckNodeSshAccess:
    description: Check cluster's node is SSH reachable from the bastion
    node: cluster.bastion
    fn: CheckNodeSshAccess
    dependency:
      - CheckNodeConf
    param: 
      - cluster.node


  AddRepoHelm:
    description: Install Helm charts repositories on the helm client (node.helm)
    node: cluster.bastion
    fn: AddRepoHelm
    param:
      - helm.repo
      - node.helm
    dependency:
      - CheckNodeSshAccess

  DeployCsiOpenEBS:
    description: Install the CSI OpenEBS provisioner (only the local storage feature), as a helm release.
    node: cluster.bastion
    fn: InstallReleaseHelm
    param:
      - helm.release
      - node.helm
    dependency:
      - AddRepoHelm

  DeployCimRegistry:
    description: deploy the app cimreg (container image registry). meaning -> make it really work
    node: cluster.bastion
    fn: ApplyManifest
    param:
      - kubectl.manifest.apply
      - node.kubectl
    dependency:
      - DeployCsiOpenEBS


  # CreateSecret:
  #   description: create a login/pwd used for Basic Auth to access the private docker registry.
  #   node: node.helm
  #   fn: CreateSecret
  #   param:
  #     - secret.cimreg
  #   dependency:
  #     - DeployCustomLpp

  # AddNamespace:
  #   description: create a namespace where to deploy the registry.
  #   node: node.helm
  #   fn: AddNs
  #   param:
  #     - app.namespace
  #   dependency:
  #     - DeployLpp

  # AddContainerRegistry:
  #   # A private cluster container registry, with admission control enforcing that only images from it can run.
  #   description: deploy A Deployement with registry:2.
  #   node: node.helm
  #   fn: AddContainerRegistry
  #   param:
  #     - helm.repo
  #   dependency:
  #     - DeployAgent


  # DeployCustomLpp:
  #   description: deploy the customized Rancher local Path Provisionner.
  #   node: node.helm
  #   fn: ApplyManifest
  #   param:
  #     - manifest.apply
  #   dependency:
  #     - DeployAgent
