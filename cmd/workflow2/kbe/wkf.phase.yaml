name: kbe
description: create KBE (Kubernetes Easy) clusters
phases:
  CheckSshConf:
    description: check node is SSH configured on the host (aka. ~/.ssh/config.d/)
    node: node.bastion
    fn: CheckSshConf
    param: 
      - node.all

  CheckSshAccess:
    description: Check node is SSH reachable from the host
    node: node.bastion
    fn: CheckSshAccess
    param:
      - node.all
    dependency:
      - CheckSshConf

  DeployAgent:
    description: copy luca agent from the host to the node (only if it is different from the host)
    node: node.bastion
    fn: DeployAgent
    param: 
      - node.all
      - agent
    dependency:
      - CheckSshAccess

  UpgradeOs:
    description: Upgrade node (linux OS) native repositories and packages to the latest version
    node: node.all
    fn: UpgradeOs
    dependency:
      - DeployAgent

  RebootIfNeeded:
    description: Reboot a node if needed
    node: node.all
    fn: RebootIfNeeded
    dependency:
      - UpgradeOs

  WaitIsOnline:
    description: Check a node is ssh reachable from a host (after a possible reboot) within a delay
    node: node.bastion
    fn: WaitIsOnline
    param: 
      - node.all
      - ssh.delay
    dependency:
      - RebootIfNeeded


  # AlignPkg:
  #   description: Provision required/missing native standard OS packages
  #   node: node.all
  #   fn: UpdateNativePkg
  #   param:
  #     - onpm.pkg.node
  #   dependency:
  #     - WaitIsOnline

  AddNativeRepo:
    description: Provision native OS package repository(ies)
    node: node.test.o1u
    fn: AddNativeRepo
    param:
      - onpm.repo.node
    dependency:
      - WaitIsOnline

  AddNativePkg:
    description: Provision native OS package(s)
    node: node.o1u
    fn: AddNativePkg
    param:
      - onpm.pkg.node.all
    dependency:
      - AddNativeRepo

  CpNativePkg:
    description: Provision native OS package(s)
    node: node.cp
    fn: Installpkg
    param:
      - onpm.pkg.cp
    dependency:
      - AddNativePkg

  KModule:
    description: Load OS kernel module(s)
    node: node.all
    fn: LoadKModule
    param:
      - kernel.module
      - file.kernel
    dependency:
      - AddNativePkg
      - CpNativePkg

  KParam:
    description: Set OS kernel parameter(s)
    node: node.all
    fn: ConfigureKParam
    param:
      - kernel.param
      - file.kernel
    dependency:
      - KModule

  Selinux:
    description: Configure SELinux
    node: node.all
    fn: ConfigureSelinux
    dependency:
      - KParam

  ServiceEnable:
    description: Enable OS services to start after a reboot
    node: node.all
    fn: EnableService
    param:
      - service.enable
    dependency:
      - Selinux

  ServiceStart:
    description: Start OS services for current session
    node: node.all
    fn: StartService
    param:
      - service.start
    dependency:
      - Selinux
      - ServiceEnable

  CpReset:
    description: Reset the control plane node(s)
    node: node.cp
    fn: ResetNode
    dependency:
      - ServiceStart

  CpInit:
    description: Initialize/bootstrap the cluster
    node: node.cp
    fn: InitCPlane
    param:
      - cluster
    dependency:
      - CpReset

  WorkerReset:
    description: Reset the worker node(s)
    node: node.worker
    fn: ResetNode
    dependency:
      - CpInit

  WorkerAdd:
    description: Add worker node(s) to the cluster
    node: node.worker
    fn: AddWorker
    param:
      - node.cp
    dependency:
      - WorkerReset

  Kubectl:
    description: Configure kubectl
    node: node.kubectl
    fn: Configure
    param:
      - node.cp
    dependency:
      - WorkerAdd

  Go:
    description: Provision Go CLI(s)
    node: node.cp
    fn: InstallGoCli
    param:
      - go.cp
    dependency:
      - Kubectl

  Rc:
    description: Create a custom RC file in user's home
    node: node.cp
    fn: CreateRc
    param:
      - file.crc
    dependency:
      - Go

  Path:
    description: Configure PATH envvar into current user's custom RC file
    node: node.cp
    fn: SetPath
    param:
      - file.crc
      - file.binf
    dependency:
      - Rc

  Helm:
    description: Install Helm chart repositories
    node: node.helm
    fn: InstallHelmRepo
    param:
      - helm.repo
    dependency:
      - Path

  Cni:
    description: Install and configure the CNI Cilium
    node: Helm
    fn: InstallCilium
    dependency:
      - Helm
