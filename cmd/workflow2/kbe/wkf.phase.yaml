name: kbe
description: create KBE (Kubernetes Easy) clusters
phases:
  CheckSshConf:
    description: check node is SSH configured on the host (aka. ~/.ssh/config.d/)
    node: node.bastion
    fn: CheckSshConf
    param: 
      - node.all

  CheckSshAccess:
    description: Check node is SSH reachable from the host
    node: node.bastion
    fn: CheckSshAccess
    param:
      - node.all
    dependency:
      - CheckSshConf

  DeployAgent:
    description: copy luca agent from the host to the node (only if it is different from the host)
    node: node.bastion
    fn: DeployAgent
    param: 
      - node.all
      - agent
    dependency:
      - CheckSshAccess

  UpgradeOs:
    description: Upgrade node (linux OS) native repositories and packages to the latest version
    node: node.all
    fn: UpgradeOs
    dependency:
      - DeployAgent

  RebootIfNeeded:
    description: Reboot a node if needed
    node: node.all
    fn: RebootIfNeeded
    dependency:
      - UpgradeOs

  WaitIsOnline:
    description: Check a node is ssh reachable from a host (after a possible reboot) within a delay
    node: node.bastion
    fn: WaitIsOnline
    param: 
      - node.all
      - ssh.delay
    dependency:
      - RebootIfNeeded

  UpdateOs:
    description: Provision required/missing native standard OS packages
    node: node.all
    fn: UpdateOs
    dependency:
      - WaitIsOnline

  AddRepoNative:
    description: Provision native OS package repository(ies)
    node: node.all
    fn: AddRepoNative
    param:
      - onpm.repo.node
    dependency:
      - UpdateOs

  AddPkgNative:
    description: Provision native OS package(s)
    node: node.all
    fn: AddPkgNative
    param:
      - onpm.pkg.node.all
    dependency:
      - AddRepoNative


  AddKModule:
    description: Load linux OS kernel module(s)
    node: node.all
    fn: AddKModule
    param:
      - kernel.module
      - file.kernel
    dependency:
      - AddPkgNative

  AddKParam:
    description: Set linux OS kernel parameter(s)
    node: node.all
    fn: AddKParam
    param:
      - kernel.param
      - file.kernel
    dependency:
      - AddKModule


  SelinuxConfigure:
    description: Configure SELinux
    node: node.all
    fn: SelinuxConfigure
    dependency:
      - AddKParam



  ServiceEnable:
    description: Enable OS services to start after a reboot
    node: node.all
    fn: EnableService
    param:
      - service.enable
    dependency:
      - SelinuxConfigure

  ServiceStart:
    description: Start an OS service for the current session
    node: node.all
    fn: StartService
    param:
      - service.start
    dependency:
      - ServiceEnable


  AddPkgNativeCp:
    description: Provision native OS package(s)
    node: node.cp
    fn: AddPkgNative
    param:
      - onpm.pkg.node.cp
    dependency:
      - ServiceStart 


  ResetCp:
    description: Reset the control plane node(s)
    node: node.cp
    fn: ResetNode
    dependency:
      - ServiceStart

  InitCp:
    description: Initialize/bootstrap the cluster
    node: node.cp
    fn: InitCPlane
    param:
      - cluster
    dependency:
      - ResetCp

  ResetWorker:
    description: Reset the worker node(s)
    node: node.worker
    fn: ResetNode
    dependency:
      - InitCp

  AddWorker:
    description: Add worker node(s) to the cluster
    node: node.worker
    fn: AddWorker
    param:
      - node.cp
    dependency:
      - ResetWorker

  ConfigureKubectl:
    description: Configure kubectl
    node: node.kubectl
    fn: Configure
    param:
      - node.cp
    dependency:
      - AddWorker

  AddPkgGo:
    description: Provision Go CLI(s)
    node: node.cp
    fn: InstallGoCli
    param:
      - go.cp
    dependency:
      - ConfigureKubectl

  AddRc:
    description: Create a custom RC file in user's home
    node: node.cp
    fn: CreateRc
    param:
      - file.crc
    dependency:
      - AddPkgGo

  Path:
    description: Configure PATH envvar into current user's custom RC file
    node: node.cp
    fn: SetPath
    param:
      - file.crc
      - file.binf
    dependency:
      - AddRc

  Helm:
    description: Install Helm chart repositories
    node: node.helm
    fn: InstallHelmRepo
    param:
      - helm.repo
    dependency:
      - Path

  Cni:
    description: Install and configure the CNI Cilium
    node: Helm
    fn: InstallCilium
    dependency:
      - Helm
