name: kbe
description: create KBE (Kubernetes Easy) clusters
phases:
  CheckSshConf:
    description: check node is SSH configured on the host (aka. ~/.ssh/config.d/)
    node: node.bastion
    fn: CheckSshConf
    param: 
      - node.all

  CheckSshAccess:
    description: Check node is SSH reachable from the host
    node: node.bastion
    fn: CheckSshAccess
    param:
      - node.all
    dependency:
      - CheckSshConf

  DeployAgent:
    description: copy luca agent from the host to the node (only if it is different from the host)
    node: node.bastion
    fn: DeployAgent
    param: 
      - node.all
      - agent
    dependency:
      - CheckSshAccess

  UpgradeOs:
    description: Upgrade node (linux OS) native repositories and packages to the latest version
    node: node.all
    fn: UpgradeOs
    dependency:
      - DeployAgent

  RebootIfNeeded:
    description: Reboot a node if needed
    node: node.all
    fn: RebootIfNeeded
    dependency:
      - UpgradeOs

  WaitIsOnline:
    description: Check a node is ssh reachable from a host (after a possible reboot) within a delay
    node: node.bastion
    fn: WaitIsOnline
    param: 
      - node.all
      - ssh.delay
    dependency:
      - RebootIfNeeded

  UpdateOs:
    description: Provision required/missing native standard OS packages
    node: node.all
    fn: UpdateOs
    dependency:
      - WaitIsOnline

  AddRepoNative:
    description: Provision native OS package repository(ies)
    node: node.all
    fn: AddRepoNative
    param:
      - onpm.repo.node
    dependency:
      - UpdateOs

  AddPkgNative:
    description: Provision native OS package(s)
    node: node.all
    fn: AddPkgNative
    param:
      - onpm.pkg.node.all
    dependency:
      - AddRepoNative

  AddKModule:
    description: Load linux OS kernel module(s)
    node: node.all
    fn: AddKModule
    param:
      - kernel.module
      - file.kernel
    dependency:
      - AddPkgNative

  AddKParam:
    description: Set linux OS kernel parameter(s)
    node: node.all
    fn: AddKParam
    param:
      - kernel.param
      - file.kernel
    dependency:
      - AddKModule

  SelinuxConfigure:
    description: Configure SELinux
    node: node.all
    fn: SelinuxConfigure
    dependency:
      - AddKParam

  ServiceEnable:
    description: Enable existing OS services to start after a reboot
    node: node.all
    fn: EnableService
    param:
      - service.enable
    dependency:
      - SelinuxConfigure

  ServiceStart:
    description: Start existing OS services for the current session
    node: node.all
    fn: StartService
    param:
      - service.start
    dependency:
      - ServiceEnable

  ServiceStop:
    description: Stop existing OS services for the current session
    node: node.all
    fn: StopService
    param:
      - service.stop
    dependency:
      - ServiceStart


  AddPkgNative2:
    description: Provision native OS package(s)
    node: node.cp
    fn: AddPkgNative
    param:
      - onpm.pkg.node.cp
    dependency:
      - ServiceStop 

  ResetCplane:
    description: Reset the control plane node(s)
    node: node.cp
    fn: ResetNode
    dependency:
      - AddPkgNative2

  InitCplane:
    description: Initialize/bootstrap the cluster
    node: node.cp
    fn: InitCplane
    param:
      - cluster.parameter
      - ContainerRuntime.socketName
    dependency:
      - ResetCplane

  ResetWorker:
    description: Reset the worker node(s)
    node: node.worker
    fn: ResetNode
    dependency:
      - InitCplane

  AddWorker:
    description: Add worker node(s) to the cluster
    node: node.worker
    fn: AddWorker
    param:
      - node.cp
    dependency:
      - ResetWorker

  ConfigureKubectl:
    description: Configure kubectl
    node: node.bastion
    fn: ConfigureKubectl
    param:
      - node.cp
      - node.kubectl
    dependency:
      - AddWorker

  AddPkgGo:
    description: install Go CLI(s)
    node: node.cp
    fn: AddPkgGo
    param:
      - gopm.cp
      - file.binf
    dependency:
      - ConfigureKubectl

  CreateRcFile:
    description: Create a user's custom RC file
    node: node.bastion
    fn: CreateRcFile
    param:
      - node.cp
      - file.crc
    dependency:
      - AddPkgGo

  RcAddPath:
    description: Update the user's custom RC file by adding the envvar:PATH
    node: node.bastion
    fn: RcAddPath
    param:
      - node.cp
      - file.binf
      - file.crc
    dependency:
      - CreateRcFile

  AddRepoHelm:
    description: Install Helm charts repositories on the helm client (node.helm)
    node: node.bastion
    fn: AddRepoHelm
    param:
      - helm.repo
      - node.helm
    dependency:
      - RcAddPath

  AddCni:
    description: Install the CNI:Cilium as a Helm:Chart in the cluster
    node: node.helm
    fn: InstallReleaseHelm
    dependency:
      - AddRepoHelm
    param:
      - helm.repo

  # AddPkgHelmCniCilium:
  #   description: Install the CNI:Cilium as a Helm:Chart
  #   node: node.helm
  #   fn: AddPkgHelm # aka. Helm chart (Pkg is not a concept in Helm language)
  #   dependency:
  #     - AddRepoHelm

  ConfigureCni:
    description: Configure CNI:Cilium for this cluster
    node: node.helm
    fn: ConfigureCilium
    dependency:
      - AddCni
