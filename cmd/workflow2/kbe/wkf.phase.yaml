name: kbe
description: create KBE (Kubernetes Easy) clusters
phases:
  Ssh:
    description: Check node is SSH reachable
    node: node.bastion
    fn: CheckSshAccess
    param: 
      - node.all
    dependency: []

  Agent:
    description: Copy LUC CLI agent
    node: node.bastion
    fn: DeployLuc
    param: 
      - node.all
    dependency:
      - Ssh

  AlignDistro:
    description: Upgrade native OS packages and repositories to version latest
    node: node.all
    fn: AlignDistro
    dependency:
      - Agent

  AlignPkg:
    description: Provision required/missing native standard OS packages
    node: node.all
    fn: UpdateNativePkg
    param:
      - onpm.pkg.node
    dependency:
      - AlignDistro

  NativeRepo:
    description: Provision native OS package repository(ies)
    node: node.all
    fn: InstallRepo
    param:
      - onpm.repo.node
    dependency:
      - AlignPkg

  NativePkg:
    description: Provision native OS package(s)
    node: node.all
    fn: InstallPkg
    param:
      - onpm.pkg.node
    dependency:
      - NativeRepo

  CpNativePkg:
    description: Provision native OS package(s)
    node: node.cp
    fn: Installpkg
    param:
      - onpm.pkg.cp
    dependency:
      - NativePkg

  KModule:
    description: Load OS kernel module(s)
    node: node.all
    fn: LoadKModule
    param:
      - kernel.module
      - file.kernel
    dependency:
      - NativePkg
      - CpNativePkg

  KParam:
    description: Set OS kernel parameter(s)
    node: node.all
    fn: ConfigureKParam
    param:
      - kernel.param
      - file.kernel
    dependency:
      - KModule

  Selinux:
    description: Configure SELinux
    node: node.all
    fn: ConfigureSelinux
    dependency:
      - KParam

  ServiceEnable:
    description: Enable OS services to start after a reboot
    node: node.all
    fn: EnableService
    param:
      - service.enable
    dependency:
      - Selinux

  ServiceStart:
    description: Start OS services for current session
    node: node.all
    fn: StartService
    param:
      - service.start
    dependency:
      - Selinux
      - ServiceEnable

  CpReset:
    description: Reset the control plane node(s)
    node: node.cp
    fn: ResetNode
    dependency:
      - ServiceStart

  CpInit:
    description: Initialize/bootstrap the cluster
    node: node.cp
    fn: InitCPlane
    param:
      - cluster
    dependency:
      - CpReset

  WorkerReset:
    description: Reset the worker node(s)
    node: node.worker
    fn: ResetNode
    dependency:
      - CpInit

  WorkerAdd:
    description: Add worker node(s) to the cluster
    node: node.worker
    fn: AddWorker
    param:
      - node.cp
    dependency:
      - WorkerReset

  Kubectl:
    description: Configure kubectl
    node: node.kubectl
    fn: Configure
    param:
      - node.cp
    dependency:
      - WorkerAdd

  Go:
    description: Provision Go CLI(s)
    node: node.cp
    fn: InstallGoCli
    param:
      - go.cp
    dependency:
      - Kubectl

  Rc:
    description: Create a custom RC file in user's home
    node: node.cp
    fn: CreateRc
    param:
      - file.crc
    dependency:
      - Go

  Path:
    description: Configure PATH envvar into current user's custom RC file
    node: node.cp
    fn: SetPath
    param:
      - file.crc
      - file.binf
    dependency:
      - Rc

  Helm:
    description: Install Helm chart repositories
    node: node.helm
    fn: InstallHelmRepo
    param:
      - helm.repo
    dependency:
      - Path

  Cni:
    description: Install and configure the CNI Cilium
    node: Helm
    fn: InstallCilium
    dependency:
      - Helm
