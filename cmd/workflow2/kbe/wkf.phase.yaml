name: kbe
description: create KBE (Kubernetes Easy) clusters
phases:
  Ssh:
    description: Check node is SSH reachable
    node: bastion
    fn: CheckSshAccess
    param: 
      - node.all
    dependency: []

  Agent:
    description: Copy LUC CLI agent
    node: all
    fn: DeployLuc
    dependency:
      - Ssh

  Os:
    description: Upgrade native OS packages and repositories to version latest
    node: all
    fn: UpgradeOs
    dependency:
      - Agent

  Pkg:
    description: Provision required/missing native standard OS packages
    node: all
    fn: UpdateNativePkg
    param:
      - da.pkg.node
    dependency:
      - Os

  NativeRepo:
    description: Provision native OS package repository(ies)
    node: all
    fn: InstallRepo
    param:
      - da.repo.node
    dependency:
      - Pkg

  NativePkg:
    description: Provision native OS package(s)
    node: all
    fn: InstallPkg
    param:
      - da.pkg.node
    dependency:
      - NativeRepo

  CpNativePkg:
    description: Provision native OS package(s) for control plane
    node: controlPlane
    fn: Installpkg
    param:
      - da.pkg.controlPlane
    dependency:
      - NativePkg

  KModule:
    description: Load OS kernel module(s)
    node: all
    fn: LoadKModule
    param:
      - osKernelModules
      - kernelFilename
    dependency:
      - NativePkg
      - CpNativePkg

  KParam:
    description: Set OS kernel parameter(s)
    node: all
    fn: ConfigureKParam
    param:
      - osKernelParams
      - kernelFilename
    dependency:
      - KModule

  Selinux:
    description: Configure SELinux
    node: all
    fn: ConfigureSelinux
    dependency:
      - KParam

  ServiceEnable:
    description: Enable OS services to start after a reboot
    node: all
    fn: EnableService
    param:
      - osServiceEnable
    dependency:
      - Selinux

  ServiceStart:
    description: Start OS services for current session
    node: all
    fn: StartService
    param:
      - osServiceStart
    dependency:
      - Selinux
      - ServiceEnable

  ResetCP:
    description: Reset the control plane node(s)
    node: controlPlane
    fn: ResetNode
    dependency:
      - ServiceStart

  CpInit:
    description: Initialize/bootstrap the cluster
    node: controlPlane
    fn: InitCPlane
    param:
      - clusterConfig
    dependency:
      - ResetCP

  WorkerReset:
    description: Reset the worker node(s)
    node: worker
    fn: ResetNode
    dependency:
      - CpInit

  WorkerAdd:
    description: Add worker node(s) to the cluster
    node: worker
    fn: AddWorker
    param:
      - controlPlaneNode
      - workerNodes
    dependency:
      - WorkerReset

  Kubectl:
    description: Configure kubectl
    node: kubectl
    fn: Configure
    param:
      - controlPlaneNodes[0]
    dependency:
      - WorkerReset

  GoCli:
    description: Provision Go CLI(s)
    node: controlPlane
    fn: InstallGoCli
    param:
      - goCli
    dependency:
      - Kubectl

  Rc:
    description: Create a custom RC file in user's home
    node: controlPlane
    fn: CreateRc
    param:
      - customRcFileName
    dependency:
      - GoCli

  Path:
    description: Configure PATH envvar into current user's custom RC file
    node: controlPlane
    fn: SetPath
    param:
      - binFolderPath
      - customRcFileName
    dependency:
      - Rc

  Helm:
    description: Install Helm chart repositories
    node: Helm
    fn: InstallHelmRepo
    param:
      - helmRepo
    dependency:
      - Path

  Cni:
    description: Install and configure the CNI Cilium
    node: Helm
    fn: InstallCilium
    dependency:
      - Helm
